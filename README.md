# DMBD Project 
> University of Trieste - Data Management and Big Data course

Our assigned project involves leveraging the TPC Benchmark H (TPC-H_V3.0.1) to enhance and fine-tune the performance of specific queries. The focus is on optimizing execution time and boosting efficiency through the implementation of indexes and materialized views. Specifically, we are tasked with improving two distinct queries: one concerning the computation of export/import revenue, and another that necessitates a choice between assessing late delivery and calculating returned item losses.

... See pdf for more information.

- [results] : Contains the direct results of the queries.
- [sql] : Contains the queries used for the project.
- [stats] : Contains the statistics generated by the queries in the results folder.
- assignment.pdf : The project assignment.
- clean.sh : Script to clean the database from all indexes and materialized views generated. (Our starting size was 14GB)
- execution.sh : Script to execute the queries and generate the results.
- get_stats.sh : Script to gather the results in order to generate the statistics.
- report.pdf : The final report of the project.
- setup.sh : Script to setup the database and generate the data. (TPC-H_V3.0.1)
- utils.sh : Some fundamental functions that e wrote to simplify the execution of the scripts.

In order to keep the repository light we didn't include the TPC-H data generator, but it can be found [here](http://www.tpc.org/tpc_documents_current_versions/current_specifications.asp).

## General Setup 

### (Optional) Linux configuration

Install the necessary packages
```bash
sudo apt-get update
sudo apt-get upgrade
sudo apt-get -y install build-essential
```

### Postgres configuration

Install postgres for linux:
```bash
sudo sh -c 'echo "deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get -y install postgresql-15
```

Start the postgres service:
```bash
# START
sudo systemctl start postgresql
# STOP
sudo systemctl stop postgresql
```

Connect locally to postgres and create an user
```bash
sudo su - postgres
psql -U postgres -d postgres
CREATE USER admin WITH PASSWORD 'admin' SUPERUSER;
```

Allow local connection (not secure, only for testing), in this file change `peer` to `md5`:
```bash
sudo nano /etc/postgresql/15/main/pg_hba.conf

# Locate: local   all             postgres                                peer
# Change to: local   all             postgres                                md5

# Locate: local   all             all                                     peer
# Change to: local   all             all                                     md5

# Restart the service
sudo systemctl restart postgresql
```

Now you can access with
```bash
psql -U admin -d postgres
```
### Sync files from host to guest
```bash
rsync -avz --exclude-from=rsyncignore ./ bigdata:~/bigdata/
```

### Database setup

Follow the script to create the database and the tables, it will compile the dbgen and generate the data.

Run the setup script
```bash
# chmod +x setup.sh
./setup.sh
```

Check the database, password is `admin`
```bash
psql -U admin -d dmbd
```

## Queries

### Setup query 1

Select a Nation

```sql
SELECT n_name FROM nation;
```

Then see `project/sql/query1.sql`

### Setup query 3

Select a Customer and a Quarter
```sql
SELECT c_name FROM customer;
SELECT EXTRACT(QUARTER FROM o_orderdate) FROM orders GROUP BY EXTRACT(QUARTER FROM o_orderdate);
```

Then see `project/sql/query3.sql`

### Run the queries

```bash
# chmod +x run_queries.sh
./run_queries.sh 'FRANCE' 'Customer#000000236' 1
```

### Get data from remote

Get the result folder from the remote server
```bash
rsync -avz bigdata:~/bigdata/results/ ./results
rsync -avz bigdata:~/bigdata/sqltest/ ./sqltest
```


### Authors
- G. Alessio - DSSC university of Trieste student 2022 
- A. Campagnolo - DSSC university of Trieste student 2022 